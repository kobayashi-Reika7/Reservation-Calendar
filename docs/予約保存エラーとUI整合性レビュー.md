# 予約保存エラーとUI整合性レビュー

医療予約システムにおいて、「ユーザー操作で防げるエラーがUIで未然に防げているか」「フロントとバックの判定が一致しているか」を重点にレビューした結果です。

---

## 1. ユーザー操作で未然に防げている点（OK）

| 観点 | 実装 | 評価 |
|------|------|------|
| **過去日** | グリッドで `isSlotAvailable`: `dateStr < todayStr` → false。週は `minWeekStartDate`（今週月曜）以降のみ表示。`canGoPrevWeek` で過去週へは行けない。 | ○ 過去日は常に ×・クリック不可。 |
| **祝日（枠表示）** | グリッドの ○/× はバックエンド API の `isHoliday` と `slots[].reservable` のみ使用。祝日はバックで全枠 × のため、フロントでも全枠 ×。 | ○ 祝日は必ず ×・disabled。 |
| **今日の過去時刻** | `isSlotAvailable`: `dateStr === todayStr && time <= currentTimeStr` → false。`currentTimeStr` は1分間隔で更新。 | ○ 過ぎた時刻は ×（※更新間隔のギャップは後述）。 |
| **予約不可枠（医師なし／満枠／デモ枠外）** | ○/× はバックの `getSlots` 結果のみで決定。フロントは `row?.availableDoctorByTime?.[time]` が truthy のときだけ ○。 | ○ バックで × なら必ず × 表示。 |
| **× の枠は disabled** | セルボタン `disabled={!available}`。`handleCellClick` 内で `if (!isSlotAvailable(...)) return`。 | ○ クリック不可。 |
| **確認画面へ進む前の再チェック** | `handleConfirm` で `isSlotAvailable(selectedDate, selectedTime)` を再度判定。false ならエラー表示し遷移しない。 | ○ 二重ガード。 |
| **診療科・種別・日付・時間の未選択** | `canProceed = department && type && selectedDate && selectedTime`。確認へ進むボタンは `disabled={!canProceed \|\| loading}`。 | ○ 未選択では確認画面へ進めない。 |
| **確認画面での必須チェック** | `handleConfirm` で `!user?.uid \|\| !selectedDate \|\| !time \|\| !department` なら API を叩かずエラー表示。 | ○ 不足時はAPI未呼び出し。 |
| **確認画面の state 欠損** | リロード等で `location.state` が消えた場合は `!selectedDate \|\| !time` で「予約内容がありません」を表示し、確定ボタンは出さない。 | ○ 空のままAPIを叩かない。 |
| **401 の発生抑制** | `/reserve/form`・`/reserve/confirm` は `ProtectedRoute` でラップ。未ログインは `/login` へリダイレクト。確定時は `user.getIdToken()` で取得したトークンを送信。 | ○ ログイン状態でのみAPI呼び出し。 |

---

## 2. 防げていない可能性がある点（NG / 要検討）

| 観点 | 内容 | リスク |
|------|------|--------|
| **今日の「過ぎた時刻」の更新遅れ** | `currentTimeStr` は 60 秒間隔の `setInterval` で更新。この間は「すでに過ぎた時刻」が最大約1分間 ○ のまま表示される可能性がある。 | ユーザーがその枠を選び確認→確定すると、バックは「今日の過去時刻」をチェックしていないため 400 にならず保存される可能性がある（実装次第）。 |
| **確認画面での二重送信** | 「予約を確定する」連打で `createReservationApi` が複数回呼ばれうる。 | 同一枠の二重予約や 400/500 の連続表示。 |
| **他ユーザーによる取り置き（競合）** | ユーザーAが ○ を選んで確認画面にいる間に、ユーザーBが同じ枠で確定すると、Aの確定時にバックで `is_reservable` が false となり 400。 | UIでは防げない。エラーメッセージで「別の時間をお選びください」と案内する現状で許容可能。 |

---

## 3. フロントとバックで条件がズレている／一致要確認の箇所

| 項目 | フロント | バックエンド | 判定 |
|------|----------|--------------|------|
| **祝日** | グリッド: API の `isHoliday` のみ使用（フロント祝日計算なし）。カレンダー: `utils/holiday.js` の `isJapaneseHoliday` で選択可否。 | `_is_japanese_holiday(date_str)` で固定祝日＋第2月曜等。 | グリッドの ○/× はバックと一致。カレンダーの「選択不可」はフロント祝日リストに依存。**祝日リストの実装が完全に同一か要確認**（成人の日・スポーツの日の式は類似だが、言語差で端数が出ないか確認推奨）。 |
| **「今日の過去時刻」** | `dateStr === todayStr && time <= currentTimeStr` で ×。 | `create_reservation` では「今日かつ時刻已過」のチェックはなし。過去日・祝日・`is_reservable` のみ。 | **バックで「今日の過去時刻」を弾いていない**。フロントの表示遅れがあると、理論上は「過ぎた時刻」で保存が通る可能性がある。 |
| **デモ枠** | ○/× はバックの `getSlots` 結果（`_demo_reservable` 含む）のみ。フロントは独自のデモ条件を持たない。 | `get_slots` と `create_reservation` の両方で `_demo_reservable`（平日 & 09:00〜11:45）を使用。 | ○ デモ条件はバック内で一致。フロントはAPI結果のみなので一致。 |
| **土日** | グリッドは「月〜金」の5列のみ。土日は表示しない。 | `_demo_reservable` で `weekday() >= 5` なら ×。医師スケジュールも曜日で判定。 | ○ 実質一致（土日はグリッドに存在しない）。 |

---

## 4. 「この条件はUI側で × 表示にすべき」という改善提案

| 条件 | 現状 | 提案 | 対応 |
|------|------|------|------|
| **今日の過去時刻** | フロントは `currentTimeStr` で × にしているが更新が最大60秒遅れうる。バックは「今日の過去時刻」をチェックしていない。 | **バックでも「今日かつ time が現在時刻以前」なら 400 で弾く**（フロントと判定を揃え、表示遅れがあっても二重で防ぐ）。 | ✅ 対応済み（`create_reservation` に今日の過去時刻チェック追加。過去日の ValueError が握りつぶされないよう修正済み） |
| **祝日** | カレンダーはフロント祝日で選択不可。グリッドはバック `isHoliday` で ×。 | **祝日リストをバックと完全に同一化**（例: バックの祝日定義をJSON等で共有し、フロントのカレンダーでも同じリストを参照する、など）。 | コメントで「同一条件にすること」を明記（式は等価のためコード変更なし） |
| **確認画面の二重送信** | 特になし。 | **「予約を確定する」クリック中はボタン disabled または loading 中は再クリック無効**。 | ✅ 対応済み（確定・修正ボタンに `disabled={loading}`、`aria-busy` 追加。loading 中もボタン表示のまま disabled） |

---

## 5. 医療予約システムとしての安全性・一貫性の提言

1. **バックエンドを単一の真実源にする**  
   - グリッドの ○/× はすでにバックの `getSlots` のみで決まっており良い。  
   - 祝日・「今日の過去時刻」など、**業務上「予約不可」にすべき条件はすべてバックで一度チェックし、400 で返す**と、フロントの不具合や表示遅れがあっても二重に防げる。

2. **「今日の過去時刻」をバックで検証する**  
   - `create_reservation` 内で、`date == today` かつ `time <= 現在時刻（分単位で比較）」なら `ValueError` で 400 を返す。  
   - フロントの `currentTimeStr` 更新間隔に依存せず、確実に防げる。  
   - **→ 対応済み。あわせてフロントの `currentTimeStr` 更新間隔を 60秒→15秒に短縮。**

3. **確認画面の送信ガード**  
   - 確定ボタンは `loading === true` の間は `disabled` にし、二重送信を防ぐ。  
   - **→ 対応済み（確定・修正ボタンに `disabled={loading}` を付与）。**

4. **祝日リストの一元化**  
   - バックの `_is_japanese_holiday` とフロントの `isJapaneseHoliday` が同じ日付で同じ結果を返すよう、式・定数を揃えるか、祝日一覧をAPI/JSONで共有する設計を検討する。

5. **エラーメッセージの統一**  
   - 400 で返す `detail` と、フロントで表示する「この時間は現在予約できません」等の文言を揃えると、ユーザーが状況を理解しやすい。

6. **アクセシビリティ・誤操作防止**  
   - セルボタンの `aria-label` で「予約可能」「祝日のため予約不可」等が分かるようになっているのは良い。  
   - 確認画面で「選択日時：02/24（火）10:30」のように1行で表示しているため、確定前の最終確認がしやすい。

---

## まとめ

- **ユーザー操作で防げる 400 系**は、過去日・祝日・予約不可枠・未選択・確認画面の必須チェックについて、ほぼUIで未然に防げている。
- **フロントとバックの判定**は、○/× がバックAPIのみで決まるため一致している。祝日リストと「今日の過去時刻」は、バック側の検証を足し、祝日リストを揃えるとより安全。
- **改善は「バックで今日の過去時刻を弾く」「祝日リストの一致」「二重送信防止の明示」**を優先すると、医療予約としての安全性・一貫性が高まる。
