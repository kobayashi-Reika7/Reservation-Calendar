# 02 セットアップとトラブル

起動手順・ログイン/新規登録・デモデータ作成・トラブル時の確認・医師データ投入をまとめています。

---

## 1. 起動手順（正常時）

| 順番 | 種別 | ポート | コマンド／操作 |
|------|------|--------|----------------|
| 1 | バックエンド | **8001** | `cd Day5/backend` → `run.bat`（Windows）または `uvicorn main:app --reload --host 127.0.0.1 --port 8001` |
| 2 | フロントエンド | **5200** | `cd Day5/frontend` → `npm run dev` |
| 3 | ブラウザ | - | http://localhost:5200 を開く |

- 事前に Firebase Console で **Authentication → サインイン方法 → メール/パスワード** を有効にしておく。
- フロントの `.env` は `frontend/.env.example` をコピーして `frontend/.env` を作成し、Firebase の設定値を入れる。

---

## 2. ログイン・新規登録・デモデータ

**ログイン（既存ユーザー）**  
1. http://localhost:5200 を開く  
2. メール・パスワードを入力 → 「ログイン」  
3. 成功すると **メニュー画面** に遷移

**新規登録**  
1. 「新規登録はこちら」→ メール・パスワード（6文字以上）→ 「登録する」  
2. 成功すると **カレンダー画面** に遷移

**デモデータ**  
カレンダーで今日以降の日付をタップ → 大分類・診療科・目的・担当医・時間を選び「確認画面へ」→ 「予約を確定する」。別の日時で 2〜3 件繰り返す。

---

## 3. トラブル時の確認

### フロント（5200）が開けない

- `cd Day5/frontend` → `npm run dev` で起動しているか確認。
- 既定は 5200。`strictPort: false` のため 5200 使用中は 5201 など別ポートで起動する（表示された URL で開く）。

### バックエンド（8002）に接続できない

- `cd Day5/backend` で `run.bat` または `uvicorn main:app --reload --host 127.0.0.1 --port 8002` で起動しているか確認。
- フロントの API 先は **8002** 固定。venv がない場合は `python -m venv venv` → `pip install -r requirements.txt` を実行。

### ログイン・新規登録ができない（Firebase）

- `frontend/.env` に Firebase 設定（VITE_FIREBASE_*）が入っているか確認。
- Firebase Console でメール/パスワードを有効にしているか、プロジェクトID・APIキーが `.env` と一致しているか確認。

### 予約一覧・予約保存ができない（Firestore）

- Firestore を有効にし、`firestore.rules` をデプロイ（`firebase deploy --only firestore:rules`）または Console にコピー。
- 複合インデックス: `firebase deploy --only firestore:indexes` で `firestore.indexes.json` をデプロイ。
- ログイン済みか確認（未ログインでは読み書き不可）。

### 「サーバーでエラーが発生しました」（予約確定で 500）

1. **実際のエラーを確認する**  
   バックエンドを **ターミナルから** 起動し、予約確定を再度試す。  
   例: `cd Day5/backend` → `.\venv\Scripts\python -m uvicorn main:app --reload --host 127.0.0.1 --port 8002`  
   画面に表示される **トレースバック（Traceback）** の最後の行が原因です。

2. **よくある原因と対処**

   | ログに出るキーワード | 原因 | 対処 |
   |----------------------|------|------|
   | `Firebase の認証情報が設定されていません` / `Could not automatically determine credentials` | Firebase Admin の認証情報がない | `backend/.env` に **GOOGLE_APPLICATION_CREDENTIALS**（サービスアカウント JSON のパス）または **FIREBASE_SERVICE_ACCOUNT_JSON**（JSON 文字列）を設定する。 |
   | `_get_firestore failed` / `Permission denied` | Firestore の権限・ルール | Firebase Console で Firestore ルールを確認。`firestore.rules` をデプロイ（`firebase deploy --only firestore:rules`）。 |
   | `collection_group` / `index` / `FAILED_PRECONDITION` | 複合インデックス未作成 | `firebase deploy --only firestore:indexes` で `firestore.indexes.json` をデプロイ。Console の「インデックス」で未完了があれば作成。 |
   | `_get_available_doctors failed` | 医師一覧取得（doctors コレクション）失敗 | `doctors` コレクションが存在するか、権限があるか確認。医師未登録の場合は USE_DEMO_SLOTS=1 でデモ枠が有効。 |
   | `Firestore ref.add failed` | 予約ドキュメントの書き込み失敗 | `users/{uid}/reservations` への書き込みがルールで許可されているか確認。 |

3. **backend/.env の例**  
   ```
   GOOGLE_APPLICATION_CREDENTIALS=C:\path\to\your\serviceAccountKey.json
   ```  
   または Firebase Console → プロジェクトの設定 → サービスアカウント → 新しい秘密鍵 → ダウンロードした JSON の**絶対パス**を上記に指定。

---

## 4. 医師データの投入（任意）

担当医を Firestore の `doctors` で管理する場合:

1. **backend/.env** に `FIREBASE_SERVICE_ACCOUNT_JSON`（サービスアカウント JSON を1行）を設定するか、PowerShell で `$env:FIREBASE_SERVICE_ACCOUNT_JSON` に JSON を設定。
2. **実行**: `cd Day5/backend` → `.\venv\Scripts\python -m scripts.seed_doctors`（Windows なら `run_seed_doctors.bat` でも可）。
3. データ定義は `backend/scripts/seed_doctors_data.py`。診療科（department）は `frontend/src/constants/masterData.js` の label と一致させる。
