# 祝日バッジ表示の確認手順（実際のコードベース）

以下は、祝日バッジが正しく表示・非表示になるかを、**実際のコードと操作**に沿って確認する手順です。

---

## 1. バックエンドを起動する

**場所**: `Day5/backend/`

- **Windows**: `run.bat` をダブルクリック、またはコマンドプロンプトで  
  `cd Day5\backend` → `run.bat`
- 起動すると `http://127.0.0.1:8002` で API が待ち受けます。
- 「venv がありません」と出た場合は、同じフォルダで  
  `python -m venv venv` → `venv\Scripts\pip install -r requirements.txt` を実行してから再度 `run.bat`。

---

## 2. フロントエンドを起動する

**場所**: `Day5/frontend/`

- ターミナルで `cd Day5/frontend` → `npm run dev`
- 表示された URL（例: `http://localhost:5200`）をブラウザで開く。

---

## 3. 祝日を含む週を表示する（例: 2026-02-11 建国記念の日）

1. **ログイン**  
   トップ → ログインし、メニューなどから予約フォームへ進む。

2. **予約フォームを開く**  
   ルートは `App.jsx` で `/reserve/form` → `ReservationFormPage`。  
   直接開く場合は `http://localhost:5173/reserve/form`（ログイン済みであること）。

3. **診療科目を選ぶ**  
   `ReservationFormPage.jsx` の `department` が空だと空き状況を取らないため、  
   例: 「循環器内科」など、いずれか 1 つ選択する。

4. **2026年2月11日を含む週を表示する**  
   - 画面上部の **「日付選択」** ボタンをクリック（`ReservationFormPage.jsx` 374行付近の `onClick={() => setCalendarOpen(true)}`）。  
   - カレンダーが開いたら、**2026年2月**に移動し、**2月11日（水）** またはその週の任意の日をクリック。  
   - `handleCalendarSelect`（231行付近）で `weekStartDate` が「その週の月曜」に設定され、  
     表には **2/9(月)〜2/13(金)** が表示され、その中の **2/11(水)** が祝日（建国記念の日）です。

   ※ 表示可能範囲は `getMinWeekStartDate()`（今週の月曜）〜 `maxWeekStartDate`（約90日先）なので、  
     今日が 2026-02-11 より前なら「翌週」を繰り返して 2/9〜2/13 の週にしても構いません。

---

## 4. コンソールで「データ取得後」のログを確認する

**出どころ**: `Day5/frontend/src/pages/ReservationFormPage.jsx` 162〜177行

```javascript
.then((rows) => {
  // ...
  rows.forEach((r) => {
    const row = { ..., isHoliday: Boolean(r.isHoliday), ... };
    next[r.dateStr] = row;
    // 一時確認用
    if (typeof console !== 'undefined' && console.log) {
      console.log('date:', row.dateStr, 'isHoliday:', row.isHoliday);
    }
  });
  setAvailByDate(next);
})
```

**手順**  
1. ブラウザで **F12** を押し、**Console** タブを開く。  
2. 上記 3 の操作で「2/9〜2/13」の週を表示した直後に、  
   **「date: 2026-02-11, isHoliday: true」** が 1 行出ているか確認する。

- **出ている** → データ取得〜 `availByDate` への格納までは問題なし。バッジが出ない場合は「6. DOM/CSS の確認」へ。
- **出ていない（2026-02-11 の行で isHoliday: false）** → バックエンドのレスポンスか、フロントのマッピングを疑う。次に「5. ネットワークで API レスポンスを確認」へ。

---

## 5. コンソールで「ヘッダ描画時」のログを確認する

**出どころ**: 同じく `ReservationFormPage.jsx` 402〜411行（`weekDates.map` 内）

```javascript
{weekDates.map((d) => {
  const dateStr = toDateStr(d);
  const row = availByDate[dateStr];
  // ...
  if (typeof console !== 'undefined' && console.log && row) {
    console.log('date:', dateStr, 'isHoliday:', row.isHoliday);
  }
  return ( ... );
})}
```

**手順**  
1. 同じ Console タブのまま、表が表示されたあとで、  
   **「date: 2026-02-11, isHoliday: true」** が再度（描画のたびに）出ているか確認する。

- **出ている** → `availByDate[dateStr]` の `isHoliday` は描画時点で true。バッジが出ないなら「6. DOM/CSS」を確認。  
- **出ていない** → その列だけ `row` が無いか `isHoliday` が false。キー `dateStr` と API で返る `date` の対応や、`availByDate` の更新タイミングを確認。

---

## 6. 祝日で isHoliday: false のとき → ネットワークで API を確認する

**手順**  
1. **F12** → **Network** タブを開く。  
2. フィルタに `slots` または `api/slots` と入れる。  
3. 再度「2/9〜2/13」の週を表示する（診療科を選び直すか、別週に移動して戻る）。  
4. 一覧から **`GET .../api/slots?department=...&date=2026-02-11`** を探し、クリック。  
5. **Response**（または Preview）で、次の形になっているか確認する。

```json
{
  "date": "2026-02-11",
  "is_holiday": true,
  "reservable": false,
  "reason": "holiday",
  "slots": [ ... ]
}
```

- **`is_holiday: true` がある** → バックエンドは正しい。フロントの `getSlots`（`backend.js`）や `getDepartmentAvailabilityForDate`（`availability.js`）、または `availByDate` の組み立て（162〜177行）を確認。  
- **`is_holiday` がない / false** → バックエンドの祝日判定を確認。  
  - `Day5/backend/reservation_service.py` の `_is_japanese_holiday(date)`（111行付近）と、  
  - `get_availability_for_date` の祝日分岐（219〜225行付近）で `is_holiday: True` を返しているか確認。

---

## 7. isHoliday: true なのにバッジが見えないとき → DOM を確認する

**手順**  
1. **F12** → **Elements**（または **インスペクト**）タブを開く。  
2. **Ctrl+F** で検索ボックスを出し、**「祝日」** と入力する。  
3. 表の 2/11(水) の列に、次のような `<span>` があるか確認する。

```html
<span class="reservation-grid-th-badge reservation-grid-th-badge-holiday">祝日</span>
```

- **存在する** → 描画はされている。見えない原因は CSS やレイアウト（重なり・非表示など）。次に「8. outline で表示確認」へ。  
- **存在しない** → 描画条件が false のまま。403行付近の `{ isHoliday && ( ... ) }` の `isHoliday` が true になっていない（コンソールの「ヘッダ描画時」ログと合わせて確認）。

---

## 8. DOM に「祝日」があるが見えないとき → outline で表示・位置を確認する

**出どころ**: `Day5/frontend/src/App.css` 400〜403行

```css
.reservation-grid-th-badge-holiday {
  color: #dc2626;
  /* 一時確認用（DOMに存在するか）: outline: 2px solid red; */
}
```

**手順**  
1. `Day5/frontend/src/App.css` を開く。  
2. 上記の **コメント行を外し**、次のようにする。

```css
.reservation-grid-th-badge-holiday {
  color: #dc2626;
  outline: 2px solid red;
}
```

3. 保存し、ブラウザをリロードして「2/9〜2/13」の週を再表示。  
4. 2/11(水) の列ヘッダに **赤い枠線** が出れば、その要素は表示されており、位置やサイズで隠れていないか確認できる。  
5. 確認後、デバッグ用の `outline` はコメントに戻してよい。

---

## まとめ（どこで何を確認するか）

| 確認内容 | 場所（コード） | 操作・見る場所 |
|----------|-----------------|----------------|
| データ取得後に isHoliday が入っているか | `ReservationFormPage.jsx` 174〜176行 | Console: `date: 2026-02-11, isHoliday: true` |
| ヘッダ描画時に row.isHoliday が true か | `ReservationFormPage.jsx` 409〜411行 | Console: 同上 |
| API が is_holiday: true を返しているか | バックエンド `reservation_service.py` | Network → `api/slots?date=2026-02-11` の Response |
| 「祝日」の span が DOM にあるか | `ReservationFormPage.jsx` 419〜421行 | Elements で「祝日」検索 |
| 要素はあるが見えないか | `App.css` 400〜403行 | コメント外して `outline: 2px solid red` で表示確認 |

この手順で、**データ → マッピング → 描画条件 → DOM → CSS** のどこで問題が出ているかを切り分けられます。

---

## 実行用メモ（手順を実行したときに記入）

| 手順 | 実施日時 | 結果（OK/NG・メモ） |
|------|----------|---------------------|
| 1. バックエンド起動 |  |  |
| 2. フロントエンド起動 |  |  |
| 3. 祝日を含む週を表示 |  |  |
| 4. コンソール「データ取得後」で `date: 2026-02-11, isHoliday: true` |  |  |
| 5. コンソール「ヘッダ描画時」で同上 |  |  |
| 6. Network で `api/slots?date=2026-02-11` の Response に `is_holiday: true` |  |  |
| 7. Elements で「祝日」の span が DOM に存在 |  |  |
| 8. outline で赤枠が表示された |  |  |

**API だけ確認する場合**: `Day5/frontend/verify_holiday_badge.js` を実行（バックエンド起動後）。  
`node verify_holiday_badge.js` で `OK date: 2026-02-11 is_holiday: true reason: holiday` が出ればバックエンドは正しい。
